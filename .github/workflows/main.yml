name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          # 1. Enable Remote Desktop (fDenyTSConnections = 0)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force

          # 2. Disable Network Level Authentication (UserAuthentication = 0)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force

          # 3. Set Security Layer to allow older clients/non-NLA (SecurityLayer = 1)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 1 -Force

          # 4. Allow RDP through the Windows Firewall
          New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound `
                              -LocalPort 3389 -Protocol TCP -Action Allow -Profile Any
